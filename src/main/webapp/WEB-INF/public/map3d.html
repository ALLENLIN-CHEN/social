<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
    <title>社保大数据业务平台</title>

    <link rel="stylesheet" href="css/bootstrap.css">
    <!-- Bootstrap core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <!-- Custom styles for this template -->

    <link rel="stylesheet" href="css/layout.css" type="text/css" media="screen" />
    <!--[if lt IE 9]>
    <link rel="stylesheet" href="css/ie.css" type="text/css" media="screen" />
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
	
	<!-- 用于图表展示与控制样式 -->
	<link href="css/3dmap.css" rel="stylesheet">
	<!-- 滚动条样式 -->
	<link href="css/jquery.mCustomScrollbar.min.css" rel="stylesheet">
	<style>
		body {
			overflow: hidden;
		}
	</style>
	<script type="text/javascript" src="js/jquery.min.js"></script>
	<script type="text/javascript" src="js/bootstrap.min.js"></script>
	<script type="text/javascript" src="js/mCustomScrollbar/jquery.mCustomScrollbar.concat.min.js"></script>
    <script src="js/hideshow.js" type="text/javascript"></script>
    <script src="js/jquery.tablesorter.min.js" type="text/javascript"></script>
    <script type="text/javascript" src="js/jquery.equalHeight.js"></script>
</head>
<body>
	<div class="navbar navbar-fixed-top navbar-inverse" >
		<div class="container">
	        <a id="logo" href="#">社保大数据业务平台</a>
	        <nav>
	            <ul class="nav navbar-nav pull-right">
	            	<li class="dropdown">
	                	<a id="dLabel" data-target="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">用卡行为分析<span class="caret"></span></a>
	                	<ul class="dropdown-menu multi-level" role="menu" aria-labelledby="dropdownMenu">
		                			<li><a href="/mychart/vindex.html">挂号业务分析</a></li>
									<li><a href="/mychart/try.html">住院登记业务分析</a></li>
									<li><a href="/mychart/hos_2.html">就医服务业务分析</a></li>
									<li><a href="/mychart/vennindex.html">电子凭证业务分析</a></li>
									<li><a href="/mychart/extindex.html">异地就医申请业务分析</a></li>
									<li><a href="/mychart/chartExpense.html">医疗费用报销业务分析</a></li>
									<li><a href="/mychart/Tsyl.html">特殊医疗待遇业务分析</a></li>
									<li><a href="/mychart/clinic.html">门诊统筹申请业务分析</a></li>
	                	</ul>
	                </li>
	                <li class="dropdown">
	                	<a id="dLabel" data-target="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">企业员工参保基数分析<span class="caret"></span></a>
	                	<ul class="dropdown-menu multi-level" role="menu" aria-labelledby="dropdownMenu">
		                			<li><a href="/company/vindex.html">单位类型社保参保基数统计分析</a></li>
									<li><a href="/company/base_3.html">各经济类型社保参保基数统计分析</a></li>
									<li><a href="/company/industry.html">各行业社保参保基数统计分析</a></li>
									<li><a href="/company/difindex.html">企业员工参保基数统计分析</a></li>
	                	</ul>
	                </li>
	                
	                <li class="dropdown">
	                	<a id="dLabel" data-target="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">业务综合分析<span class="caret"></span></a>
	                	<ul class="dropdown-menu multi-level" role="menu" aria-labelledby="dropdownMenu">
		                			<li><a href="/mychart/screen.html" target="_blank">挂号业务综合分析</a></li>
									<li><a href="/company/maptest.html" target="_blank">就医服务综合分析</a></li>
									<li><a href="/company/bigscreenshow.html" target="_blank">企业员工参保基数综合分析</a></li>
									<li><a href="/company/industrydisplay.html" target="_blank">各行业社保参保基数综合分析</a></li>
	                	</ul>
	                </li>
	                
	                <li class="dropdown">
	                	<a id="dLabel" data-target="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">社会关系转移分析<span class="caret"></span></a>
	                	<ul class="dropdown-menu multi-level" role="menu" aria-labelledby="dropdownMenu">
		                			<li><a href="/social/staff.html">社会关系转移分析</a></li>
									<li><a href="/social/map3d.html">柱状统计地图分析</a></li>
	                	</ul>
	                </li>
					<li><a href="/list/allList.html">社保数据列表展示</a></li>
					<li><a href="/list/recommend.html" target="_blank">就业推荐</a></li>

	            </ul>
	        </nav>
	    </div>
	</div>
	
	<!-- 图表展示与控制容器 -->
	<div class="scut-container">
			<div class="left-content">
				<span class="desc">
					<span id="stime">2010</span>年-<span id="etime">2010</span>年时间段中，
					<span id="area">全国</span>流入流出统计如下：
				</span>
				<ul class="list-in-out">
					<li>流入人次最多地区为：<span class="child in-most"></span></li>
					<li>流出人次最多地区为：<span class="child out-most"></span></li>
					<li>流入流出比例最高为：<span class="child per-most"></span></li>
				</ul>
			</div>

			<div class="right-content">
				<div class="time_wrap" style="display:block;">
					<div class="form-group clearfix">
						<label class="control-label col-sm-2">起始时间(年份)</label>
						<div class="col-sm-2">
							<select class="form-control startTime">
							  <option value="2010">2010年</option>
							  <option value="2011">2011年</option>
							  <option value="2012">2012年</option>
							  <option value="2013">2013年</option>
							  <option value="2014">2014年</option>
							  <option value="2015">2015年</option>
							</select>
						</div>
						<label class="control-label col-sm-2">结束时间(年份)</label>
						<div class="col-sm-2">
							<select class="form-control endTime">
							  <option value="2010">2010年</option>
							  <option value="2011">2011年</option>
							  <option value="2012">2012年</option>
							  <option value="2013">2013年</option>
							  <option value="2014">2014年</option>
							  <option value="2015">2015年</option>
							</select>
						</div>
						<button type="button" class="btn btn-primary col-sm-1 search">搜索</button>
					</div>
				</div>
				<div class="tag">
					<div class="col-sm-2"><i class="in"></i><span>流入</span></div>
					<div class="col-sm-2"><i class="out"></i><span>流出</span></div>
<!-- 					<div class="col-sm-4"><span class="area china">全国</span><span class="area child-area">广东省</span></div> -->
				</div>

				<div class="single">
					<div id="chartMain"></div>
<!-- 					<div class="area-label clearfix"> -->
<!-- 						<div class="col-sm-12"><span class="area china has-child">全国</span><span class="area child-area">广东省</span></div> -->
<!-- 					</div> -->
				</div>

				<div class="spinner">
					<div class="rect1"></div>
					<div class="rect2"></div>
					<div class="rect3"></div>
					<div class="rect4"></div>
					<div class="rect5"></div>
				</div>

			</div>
			

		</div>
	
	<script type="text/javascript" src = "js/geoCP.js"></script>
	<script src="js/echarts-2.2.7/build/dist/echarts.js"></script>
	<!-- 引入 ECharts-X 主文件 -->
	<script src="js/echarts-x-0.2.0/build/dist/echarts-x.js"></script>
	<script type="text/javascript">
	var listIn, listOut, cities = [];
	var myChart, $spinner;
	function setConclusion() {
		$('#stime').html($('.startTime').val());
		$('#etime').html($('.endTime').val());
		listIn.sort(function(x, y) {
			return y.num - x.num;
		});
		listOut.sort(function(x, y) {
			return y.num - x.num;
		});
		
		$('.in-most').html(listIn[0].name + " " + listIn[0].num + "人次");
		$('.out-most').html(listOut[0].name  + " " + listOut[0].num + "人次");
		
		listOut.sort(function(x, y) {
			return y.percent - x.percent;
		});
		
		$('.per-most').html(listOut[0].name + " " + (listOut[0].percent).toFixed(3) + '%');
		
	}
	
	// 获取数据
	function getData() {
		$spinner.show();
		$.ajax({
        	type: 'POST',
        	url: 'social/staff/treeMap',
        	dataType: 'json',
        	async: true,
        	data: {sTime:$('.startTime').val(), eTime:$('.endTime').val()},
        	success: function(res) {
        		var i, index;
        		var inData = [], inMax = 0;
        		var outData = [], outMax = 0;
        		listIn = res.listIn;
        		listOut = res.listOut;
        		
        		for(i = 0; i < listIn.length; i++) {
        			inMax = Math.max(inMax, listIn[i].num);
        			if(listIn[i].name === '上海市') {
        				inData.push({
        					geoCoord: geoCP['黄浦区'],
        					value: listIn[i].num,
        					itemStyle: {normal:{color:'#009688'}}
        				});
        			} else if(listIn[i].name === '北京市') {
        				inData.push({
        					geoCoord: geoCP['朝阳区'],
        					value: listIn[i].num,
        					itemStyle: {normal:{color:'#009688'}}
        				});
        			} else {
        				index = listIn[i].name.split('-')[1];
        				inData.push({
        					geoCoord: geoCP[index],
        					value: listIn[i].num,
        					itemStyle: {normal:{color:'#009688'}}
        				});
        			}
        		}
        		
        		for(i = 0; i < listIn.length; i++) {
        			if(listIn[i].name === '上海市') {
        				cities.push({
        					geoCoord: [geoCP['黄浦区'][0]-0.2, geoCP['黄浦区'][1]-0.3],
        					name: listIn[i].name,
        					itemStyle: {normal:{color:'transparent'}}
        				});
        			} else if(listIn[i].name === '北京市') {
        				cities.push({
        					geoCoord: [geoCP['朝阳区'][0]-0.2, geoCP['朝阳区'][1]-0.3],
        					name: listIn[i].name,
        					itemStyle: {normal:{color:'transparent'}}
        				});
        			} else {
        				index = listIn[i].name.split('-')[1];
        				cities.push({
        					geoCoord: [geoCP[index][0]-0.2, geoCP[index][1]-0.3],
        					name: index,
        					itemStyle: {normal:{color:'transparent'}}
        				});
        			}
        		}
        		
        		for(i = 0; i < inData.length; i++) {
        			inData[i].barHeight = inData[i].value / inMax * 50 + 0.1;
        		}
        		
        		for(i = 0; i < listOut.length; i++) {
        			outMax = Math.max(outMax, listOut[i].num);
        			if(listOut[i].name === '上海市') {
        				outData.push({
        					geoCoord: [geoCP['黄浦区'][0]+0.3, geoCP['黄浦区'][1]],
        					value: listOut[i].num,
        					itemStyle: {normal:{color:'#e51c23'}}
        				});
        			} else if(listOut[i].name === '北京市') {
        				outData.push({
        					geoCoord: [geoCP['朝阳区'][0]+0.3, geoCP['朝阳区'][1]],
        					value: listOut[i].num,
        					itemStyle: {normal:{color:'#e51c23'}}
        				});
        			} else {
        				index = listOut[i].name.split('-')[1];
        				outData.push({
        					geoCoord: [geoCP[index][0]+0.3, geoCP[index][1]],
        					value: listOut[i].num,
        					itemStyle: {normal:{color:'#e51c23'}}
        				});
        			}
        		}
        		
        		for(i = 0; i < outData.length; i++) {
        			outData[i].barHeight = outData[i].value / outMax * 50 + 0.1;
        		}
        		
        		var option = {
    	    			title: {
    	    				text: ''
    	    			},
    	    			series: [{
    	    				type: 'map3d',
    	                    mapType: 'china',
    	                    baseLayer: {
    	                        backgroundColor: 'rgba(248, 248, 248, 1)'
    	                    },
    	                    data: [{}],
    	                    flat: true,
    	
    	                    flatAngle: 50,
    	                    hoverable: false,
    	                    clickable: false,
    	                    roam: {
    	                        minZoom: 1,
    	                        zoom: 2.0,
    	                        maxZoom: 10.0,
    	//                         focus: '广东'
    	                    },
    	                    itemStyle: {
    	                        normal: {
    	                        	label:{show: false},
    	                            areaStyle: {
    	                                color: '#91a7ff'
    	                            },
    	                            borderColor: 'rgb(255, 211, 108)'
    	                        },
    	                        emphasis: {
    	                        	areaStyle: {
    	                                color: 'rgba(0, 150, 200, 0.8)'
    	                            }
    	                        }
    	                    },
    	                    markBar: {
    	                        barSize: 2,
    	                        data: inData.concat(outData)
//	    	                        	[{geoCoord:[113.43,23.16], barHeight:10, itemStyle: {normal:{color:'rgb(206, 139, 124)'}}},{geoCoord:[113.73,23.16], barHeight:20, itemStyle: {normal:{color:'rgb(208, 49, 16)'}}},
//	    	                               {geoCoord:[114.07,22.62], barHeight:10, itemStyle: {normal:{color:'rgb(206, 139, 124)'}}},{geoCoord:[114.37,22.62], barHeight:20, itemStyle: {normal:{color:'rgb(208, 49, 16)'}}}]
    	                   	},
    	                   markPoint: {
    	                	   clickable: false,
    	                	   hoverable: false,
    	                	   symbol: 'circle',
    	                	   symbolSize: 10,
    	                	   itemStyle: {
    	                		   normal: {
    	                           		label:{show: true, textStyle:{fontSize:30},formatter: function(v){return v.name;}},
    	                           		borderColor: 'transparent',
    	                           		borderWidth: 1
    	                		   }
    	                	   },
    	                	   orientation: 'normal',
    	                	   data: cities
//	    	                	   [{name:'佛山市',geoCoord: geoCP['佛山市'],itemStyle: {normal:{color:'transparent'}}}]
    	                  }
    	    			}]
    	    		};
    	         myChart.setOption(option);
    	         setConclusion();
    	         $spinner.hide();
        	},
        	error: function(err) {
        		alert(JSON.stringify(err));
        		$spinner.hide();
        	}
        });
	}
	
	$(function() {
		$spinner = $('.spinner');
		// 配置后续加载的各种 chart 配置 config
	    require.config({
	        paths: {
	            'echarts': 'js/echarts-2.2.7/build/dist',
	            'echarts-x': 'js/echarts-x-0.2.0/build/dist'
	        }
	    });
	
	    // 然后就可以动态加载图表进行绘制啦
	    require([
	        'echarts',
	        'echarts-x',
	        // ECharts-X 中 map3d 的地图绘制基于 ECharts 中的 map。
	        'echarts/chart/map',
	        'echarts-x/chart/map3d'
	    ], function (ec) {
	        // 跟 ECharts 一样的方式初始化
	        myChart = ec.init(document.getElementById('chartMain'));
	        getData();
	        
			
	// 		myChart.on('click', function(param) {
	// 			option.series[0].mapType = param.name;
	// 			option.series[0].clickable = false;
	// 			myChart.setOption(option);
	// 		});
		});
	    
	    $('.search').on('click', function() {
	    	if($('.startTime').val()> $('.endTime').val()) {
	    		alert('初始时间不能大于结束时间！');
	    		return;
	    	}
	    	getData();
	    });
	});
    </script>
</body>

</html>